<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MainCpu Software Documentation: CANopen Device Communication Protocol Interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="Stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MainCpu Software Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">CANopen Device Communication Protocol Interface </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md41"></a>
Abstract</h1>
<p >Most of the Gantry devices communicate through the CanOpen based protocol over the FlexCAN hardware interface.</p>
<p >Every device is assigned to a unique node of the CAN network, and develops its own command and data interface.</p>
<p >The CanOpen protocol is a complex set of functions: however it is only partially implemented here.</p>
<p >In this section it will be described the protocol implementation and the general rules the device shall follow in developing their interfaces compliant with this implamentation.</p>
<h1><a class="anchor" id="autotoc_md42"></a>
CANopen Protocol Description</h1>
<p >The protocol structure is Master/Slave:</p><ul>
<li>The Gantry is the Master of the commnunication;</li>
<li>The devices are the Slaves of the communication;</li>
</ul>
<p >Follows a list of the CANOpen protocol section implemented:</p><ul>
<li>Network Management (NMT) packets;</li>
<li>Service Data Object (SDO) packets;</li>
</ul>
<p >Follows a list of the CANOpen protocol section not implemented:</p><ul>
<li>Process Data Object (PDO) packets;</li>
<li>Emergency Object (EMCY) packets;</li>
<li>Synchronization Object (SYNC) packets;</li>
</ul>
<p >The protocol, based on the CANOpen packets data frame, shall implement the following functions:</p><ul>
<li>Operating mode management;</li>
<li>Read and Write of the internal data registers;</li>
<li>Command execution;</li>
<li>Loader Interface;</li>
</ul>
<h2><a class="anchor" id="autotoc_md43"></a>
Frame data format</h2>
<p >The protocol uses the standard frame format:</p><ul>
<li>8 byte as payload;</li>
<li>11 bit CAN ID field;</li>
</ul>
<p >The protocol shall not implement the flexible frame format that extends the payload content up to 64 byte.</p>
<h2><a class="anchor" id="autotoc_md44"></a>
Network management and Device operating status</h2>
<p >The device shall implement three internal operating status:</p><ul>
<li>LOADER operating mode (see the Loader section below): the Device is running the Loader program;</li>
<li>IDLE operating mode: the Device is in a Safer not running mode.<br  />
 This is a tipical initial status after the Device reset or exiting from a Loader session.</li>
<li>RUNNING operating mode: the device runs the operating functons.</li>
</ul>
<p >The Device shall update the Status Register of the Object Dictionary registers (seeService Data Object <b>SDO</b> section),<br  />
 with the current internal operating mode.<br  />
 The Gantry checks the current Device Internal status, reading the Device Status register.<br  />
 </p>
<h3><a class="anchor" id="autotoc_md45"></a>
Network Management NMT frames</h3>
<p >The Device shall implement the following NMT frames in order to handle<br  />
 the internal status management:</p>
<dl class="section attention"><dt>Attention</dt><dd>The Device shall not answer to the NMT packets.</dd></dl>
<h4><a class="anchor" id="autotoc_md46"></a>
Reset NMT frame</h4>
<p >The Device shall reset the internal program and set the IDLE operating mode;</p>
<a class="anchor" id="CAN-NMT"></a>
<table class="doxtable">
<caption>Reset Frame Packet Format</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 </th><th>B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0 </td><td>0x81 </td><td>DevId </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
</ul>
<h4><a class="anchor" id="autotoc_md47"></a>
Idle NMT frame</h4>
<p >The target Device shall set the IDLE operating mode;</p>
<a class="anchor" id="IDLE-NMT"></a>
<table class="doxtable">
<caption>IDLE Frame Packet Format</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 </th><th>B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0 </td><td>0x1 </td><td>DevId </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
</ul>
<h4><a class="anchor" id="autotoc_md48"></a>
Run NMT frame</h4>
<p >The target Device shall set the RUNNING operating mode;</p>
<a class="anchor" id="RUN-NMT"></a>
<table class="doxtable">
<caption>Run Frame Packet Format</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 </th><th>B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0 </td><td>0x2 </td><td>DevId </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
</ul>
<h4><a class="anchor" id="autotoc_md49"></a>
Loader NMT frame</h4>
<p >The target Device shall set the LOADER operating mode;</p>
<a class="anchor" id="LOADER-NMT"></a>
<table class="doxtable">
<caption>LOADER Frame Packet Format</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 </th><th>B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0 </td><td>0x3 </td><td>DevId </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td><td>- </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
</ul>
<h2><a class="anchor" id="autotoc_md50"></a>
Service Data Object (SDO) packets and Device activities control</h2>
<p >The Device shall implement the SDO packet protocol in order to implement the data and control interface with the Gantry.</p>
<p >The SDO protocol makes use of a so called Object Dictionary:<br  />
 a set of Internal formatted registers, with a defined access method,<br  />
 that the Device makes accessible through the CANOpen in order <br  />
 to allow Read/Write and Command operations.<br  />
 A register in the Object Dictionary is defined by:</p>
<a class="anchor" id="OD-REGISTER"></a>
<table class="doxtable">
<caption>Object Dictionary Register Format</caption>
<tr>
<th>INDEX </th><th>SUB-INDEX </th><th>DATA </th></tr>
<tr>
<td>0:0xFFFF </td><td>0:0xFF </td><td>Register data content </td></tr>
</table>
<p><br  />
 The register DATA content can be 8 to 32 bit Integer value.<br  />
 The unsigned or signed type is implementation dependent.</p>
<p >The Master (Gantry) can access in Read\Write mode the Registers with the following methods:</p>
<ul>
<li>Read access mode;</li>
<li>Write access mode;</li>
</ul>
<h3><a class="anchor" id="autotoc_md51"></a>
OD Registers Read Access</h3>
<ul>
<li>The Gantry sends a &lt;Gantry Read OD packet&gt; to the Device;</li>
<li>The Device send back a &lt;Device OD Read Content packet&gt; or a &lt;Device OD Read Error packet&gt;</li>
</ul>
<a class="anchor" id="CAN-READ-OD"></a>
<table class="doxtable">
<caption>Gantry OD Read packet</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 - B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0x600 + DevId </td><td>0x40 </td><td>Idx </td><td>SubIdx </td><td>D1 </td><td>D2 </td><td>D3 </td><td>D4 </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
<li>Idx: Idx: Register's index little endian format: B1 + 256 * B2;</li>
<li>SubIdx: Register's sub index;</li>
<li>D1 - D4: optional parameters.</li>
</ul>
<a class="anchor" id="CAN-READCONT-OD"></a>
<table class="doxtable">
<caption>Device OD Read Content packet</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 - B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0x580 + DevId </td><td>DataFormat </td><td>Idx </td><td>SubIdx </td><td>D[0:7] </td><td>D[8:15] </td><td>D[16:23] </td><td>D[24:31] </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
<li>Idx: Idx: Register's index little endian format: B1 + 256 * B2;</li>
<li>SubIdx: Register's sub index;</li>
<li>DataFormat:<ul>
<li>0x4F: 8 bit data (Data = B4);</li>
<li>0x4B: 16 bit data (Data = B4 + 256 * B5);</li>
<li>0x47: 24 bit data (Data = B4 + 0xFF * B5 + 0xFFFF * B6)</li>
<li>0x43: 32 bit data (Data = B4 + 0xFF * B5 + 0xFFFF * B6 + 0xFFFFFF * B7)</li>
</ul>
</li>
</ul>
<a class="anchor" id="CAN-READERR-OD"></a>
<table class="doxtable">
<caption>Device OD Read Error packet</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 - B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0x580 + DevId </td><td>0x80 </td><td>Idx </td><td>SubIdx </td><td>D1 </td><td>D2 </td><td>D3 </td><td>D4 </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
<li>Idx: Idx: Register's index little endian format: B1 + 256 * B2;</li>
<li>SubIdx: Register's sub index;</li>
<li>D1-D4: 32 bit error code</li>
</ul>
<h3><a class="anchor" id="autotoc_md52"></a>
OD Registers Write Access</h3>
<ul>
<li>The Gantry sends a &lt;Gantry Write OD packet&gt; to the Device;</li>
<li>The Device send back a &lt;Device OD Write Confirm packet&gt; or a &lt;Device OD Write Error packet&gt;</li>
</ul>
<a class="anchor" id="CAN-WRITE-OD"></a>
<table class="doxtable">
<caption>Gantry Write OD packet</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 - B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0x600 + DevId </td><td>DataFormat </td><td>Idx </td><td>SubIdx </td><td>D1 </td><td>D2 </td><td>D3 </td><td>D4 </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
<li>Idx: Register's index little endian format: B1 + 256 * B2;</li>
<li>SubIdx: Register's sub index;</li>
<li>DataFormat:<ul>
<li>0x2F: 8 bit data (Data = B4);</li>
<li>0x2B: 16 bit data (Data = B4 + 256 * B5);</li>
<li>0x27: 24 bit data (Data = B4 + 0xFF * B5 + 0xFFFF * B6)</li>
<li>0x23: 32 bit data (Data = B4 + 0xFF * B5 + 0xFFFF * B6 + 0xFFFFFF * B7)</li>
</ul>
</li>
<li>D1-D7: Data to be written;</li>
</ul>
<a class="anchor" id="CAN-WRITECONF-OD"></a>
<table class="doxtable">
<caption>Device OD Write Confirm packet</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 - B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0x580 + DevId </td><td>060 </td><td>Idx </td><td>SubIdx </td><td>D1 </td><td>D1 </td><td>D3 </td><td>D4 </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
<li>Idx: Idx: Register's index little endian format: B1 + 256 * B2;</li>
<li>SubIdx: Register's sub index;</li>
<li>D1-D4: Optional data.</li>
</ul>
<a class="anchor" id="CAN-WRITEERR-OD"></a>
<table class="doxtable">
<caption>Device OD Write Error packet</caption>
<tr>
<th>CANID </th><th>B0 </th><th>B1 - B2 </th><th>B3 </th><th>B4 </th><th>B5 </th><th>B6 </th><th>B7 </th></tr>
<tr>
<td>0x580 + DevId </td><td>0x80 </td><td>Idx </td><td>SubIdx </td><td>D1 </td><td>D2 </td><td>D3 </td><td>D4 </td></tr>
</table>
<p><br  />
 Where:</p><ul>
<li>DevId: Device's node;</li>
<li>Idx: Idx: Register's index little endian format: B1 + 256 * B2;</li>
<li>SubIdx: Register's sub index;</li>
<li>D1-D4: 32 bit error code</li>
</ul>
<h2><a class="anchor" id="autotoc_md53"></a>
DEVICE REGISTER ALLOCATION TABLE</h2>
<p >The Device shall organize its internal registers address space as described in the following table:</p>
<a class="anchor" id="DEV-OD-ALLOC"></a>
<table class="doxtable">
<caption>Device's OD Allocation Table</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>ALLOCATION TYPE </th></tr>
<tr>
<td>0x0000 </td><td>0:255 </td><td>Status registers </td></tr>
<tr>
<td>0x0001:0x7FFF </td><td>0:255 </td><td>Device's data registers </td></tr>
<tr>
<td>0x8000:0xEFFF </td><td>0:255 </td><td>Device's command registers </td></tr>
<tr>
<td>0xFFFF </td><td>0:255 </td><td>Loader registers </td></tr>
</table>
<p><br  />
</p>
<h3><a class="anchor" id="autotoc_md54"></a>
Device status register</h3>
<p >The Device shall reserve the Addresses 0x0000:0 to 0x0000:FF to the Read Only Status registers space:</p>
<a class="anchor" id="DEV-OD-STATUS"></a>
<table class="doxtable">
<caption>Device OD Status Register Table</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D4 - D7 </th></tr>
<tr>
<td>0x0000 </td><td>0 </td><td>OPERATING STATUS </td></tr>
<tr>
<td>0x0000 </td><td>1 </td><td>DEVICE ERRORS </td></tr>
<tr>
<td>0x0000 </td><td>2 </td><td>PROGRAM REVISION CODE </td></tr>
<tr>
<td>0x0000 </td><td>3 to FF </td><td>Application status registers </td></tr>
</table>
<p><br  />
 </p><a class="anchor" id="DEV-OD-OPER-STATUS"></a>
<table class="doxtable">
<caption>Device Operating Mode Register</caption>
<tr>
<th>ADDRESS </th><th>REGISTER NAME </th></tr>
<tr>
<td>0x0000:0 </td><td>Device Operating Mode </td></tr>
<tr>
<th>VALUE </th><th>DESCRIPTION </th></tr>
<tr>
<td>1 </td><td>IDLE STATUS </td></tr>
<tr>
<td>2 </td><td>RUNNING STATUS </td></tr>
<tr>
<td>3 </td><td>LOADER STATUS </td></tr>
</table>
<p><br  />
 </p><a class="anchor" id="DEV-OD-ERROR-STATUS"></a>
<table class="doxtable">
<caption>Error Condition Register</caption>
<tr>
<th>ADDRESS </th><th>REGISTER NAME </th></tr>
<tr>
<td>0x0000:1 </td><td>Error condition </td></tr>
<tr>
<th>VALUE </th><th>DESCRIPTION </th></tr>
<tr>
<td>0 </td><td>no error condition </td></tr>
<tr>
<td>code </td><td>Current error code </td></tr>
</table>
<p><br  />
 </p><a class="anchor" id="DEV-OD-REV-CODE"></a>
<table class="doxtable">
<caption>Program Revision Register</caption>
<tr>
<th>ADDRESS </th><th>REGISTER NAME </th></tr>
<tr>
<td>0x0000:2 </td><td>Program Revision </td></tr>
<tr>
<th>D0 - D1 </th><th>D2- D3 </th></tr>
<tr>
<td>Maj Code </td><td>Minor Code </td></tr>
</table>
<p><br  />
 </p>
<h2><a class="anchor" id="autotoc_md55"></a>
Command implementation</h2>
<p >The Device shall reserve the registers address space from 0x8000 to 0xEFFF for commands implementation.</p>
<p >The Command implementation is an extension of the Read/Write register access:<br  />
 a part of the device register address space shall be reserved <br  />
 to registers for wich:</p><ul>
<li>if the Gantry writes a register, it is requesting a command execution;</li>
<li>if the Gantry reads a register, it is requesting the result of a command execution;</li>
<li>The Device shall acknowledge the Write or Read request with the Error Packet in case the command should not be executed or it should still executing (see further section).</li>
</ul>
<h3><a class="anchor" id="autotoc_md56"></a>
Command execution specification</h3>
<p >Follows a description about the Command transactions:</p>
<h4><a class="anchor" id="autotoc_md57"></a>
Gantry Command Request Event</h4>
<p >Gantry requests a command execution writing a Command OD register:</p>
<a class="anchor" id="COMMAND-OD-REGISTER"></a>
<table class="doxtable">
<caption>Command Register content</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 - D3 </th></tr>
<tr>
<td>Command-Idx </td><td>Command-SubIdx </td><td>Command Parameters </td></tr>
</table>
<p><br  />
 In case the command is accepted or it should immediatelly completes,<br  />
 the Device shall acknowledge the write packet with the <a class="el" href="_p_g__t_d__c_a_n__o_p_e_n.html#CAN-WRITECONF-OD">CAN-WRITECONF-OD</a> packet:</p>
<a class="anchor" id="DEV-OD-COMMAND-ACK-OK"></a>
<table class="doxtable">
<caption>Command Positive Ack packet</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 </th><th>D1 - D3 </th></tr>
<tr>
<td>Command-Idx </td><td>Command-SubIdx </td><td>COMMAND STATUS </td><th>- </th></tr>
</table>
<p><br  />
 </p><a class="anchor" id="DEV-OD-COMMAND-STATUS"></a>
<table class="doxtable">
<caption>Command execution status values</caption>
<tr>
<th>VALUE </th><th>NAME </th><th>DESCRIPTION </th></tr>
<tr>
<td>1 </td><td>READY </td><td>The Command is executed istantly and successfully terminated. </td></tr>
<tr>
<td>2 </td><td>EXECUTING </td><td>The Command is started. </td></tr>
</table>
<p><br  />
 In case the command should be immediatelly rejected,<br  />
 the Device shall acknowledge the Write packet with the <a class="el" href="_p_g__t_d__c_a_n__o_p_e_n.html#CAN-WRITEERR-OD">CAN-WRITEERR-OD</a> packet:</p>
<a class="anchor" id="DEV-OD-COMMAND-ACK-NOK"></a>
<table class="doxtable">
<caption>Device command rejected packet</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 </th><th>D1 - D3 </th></tr>
<tr>
<td>CommandIdx </td><td>CommandSubIdx </td><td>Error Status </td><td>Error Code (only with ErrorStatus == COMMAND ERROR) </td></tr>
</table>
<p><br  />
 </p><a class="anchor" id="DEV-OD-COMMAND-ERROR"></a>
<table class="doxtable">
<caption>Command error status values</caption>
<tr>
<th>VALUE </th><th>NAME </th><th>DESCRIPTION </th></tr>
<tr>
<td>3 </td><td>BUSY </td><td>The Command is already running or another command is running. </td></tr>
<tr>
<td>4 </td><td>COMMAND ERROR </td><td>The command failed. See the Error Code field. </td></tr>
<tr>
<td>5 </td><td>INVALID DATA </td><td>The data/parameters are invalid or no more accessible. </td></tr>
<tr>
<td>6 </td><td>INVALID ACCESS </td><td>The requested command cannot be executed in this Device current status. </td></tr>
<tr>
<td>7 </td><td>NOT IMPLEMENTED </td><td>The requested command is not yet implemented. </td></tr>
</table>
<dl class="section attention"><dt>Attention</dt><dd>The Device shall invalidate the command result data as soon as the<br  />
 Gantry reads the related command register. The Device shall answer<br  />
 with an error of INVALID DATA code if the Gantry further access the<br  />
 already processed command register, until a new command will be requested.</dd></dl>
<h4><a class="anchor" id="autotoc_md58"></a>
Command Execution Result Check</h4>
<p >In case the command should be executing (see previous section) <br  />
 Gantry shall polling the command register address in order to <br  />
 detect the command completion and, eventually, the data result.</p>
<p >In case the command should successfully complete, <br  />
 the Device shall acknowledge the read packet with the <a class="el" href="_p_g__t_d__c_a_n__o_p_e_n.html#CAN-READCONT-OD">CAN-READCONT-OD</a> packet:</p>
<a class="anchor" id="DEV-OD-COMMAND-READ-OK"></a>
<table class="doxtable">
<caption>Command Complete Ack packet</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 - D3 </th></tr>
<tr>
<td>Command-Idx </td><td>Command-SubIdx </td><td>Command data result (optional) </td></tr>
</table>
<p><br  />
 In case the command should not be completed yet, or it should be terminated in error,<br  />
 the Device shall acknowledge the Read packet with the <a class="el" href="_p_g__t_d__c_a_n__o_p_e_n.html#CAN-READERR-OD">CAN-READERR-OD</a> packet:</p>
<a class="anchor" id="DEV-OD-COMMAND-READ-NOK"></a>
<table class="doxtable">
<caption>Device command read error packet</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 </th><th>D1 - D3 </th></tr>
<tr>
<td>Command-Idx </td><td>Command-SubIdx </td><td>Error Status </td><td>Error Code (only with ErrorStatus == COMMAND ERROR) </td></tr>
</table>
<p><br  />
 </p><a class="anchor" id="DEV-OD-COMMAND-ERROR"></a>
<table class="doxtable">
<caption>Command error status values</caption>
<tr>
<th>VALUE </th><th>NAME </th><th>DESCRIPTION </th></tr>
<tr>
<td>2 </td><td>EXECUTING </td><td>The Command is still running. </td></tr>
<tr>
<td>3 </td><td>COMMAND ERROR </td><td>The command failed. See the Error Code field. </td></tr>
<tr>
<td>4 </td><td>INVALID DATA </td><td>No more accessible (No command processed). </td></tr>
</table>
<p><br  />
</p>
<h2><a class="anchor" id="autotoc_md59"></a>
LOADER PROTOCOL</h2>
<p >The Device Index Address space Idx == 0xFFFF::XX is reserved for commands related to the Loader Protocol.</p>
<p >The Loader protocol is a part of the CAN Protocol used to upload the Device's program code via Can protocol, without the use of an external Hardware Programmer.</p>
<p >The Loader protocol features are:</p><ul>
<li>Remote Device Loader activation;</li>
<li>Loader firmware uploading;</li>
</ul>
<dl class="section attention"><dt>Attention</dt><dd>The protocol handles only the full firmware upload function. Other memory read/write operations are not implemented here.</dd></dl>
<h3><a class="anchor" id="autotoc_md60"></a>
Loader Registers</h3>
<p >Device shall implement the following OD Read/Write registers<br  />
 to handle the Loader activities:</p>
<a class="anchor" id="LOADER-REGISTERS-OD"></a>
<table class="doxtable">
<caption>Loader Registers List</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 - D4 </th><th>GANTRY ACCESS MODE </th></tr>
<tr>
<td>0xFFFF </td><td>0 </td><td>START FLASH ADDRESS </td><td>READ ONLY </td></tr>
<tr>
<td>0xFFFF </td><td>1 </td><td>END FLASH ADDRESS </td><td>READ ONLY </td></tr>
<tr>
<td>0xFFFF </td><td>2 </td><td>CHECKSUM </td><td>READ/WRITE </td></tr>
<tr>
<td>0xFFFF </td><td>3 </td><td>LOADER COMMANDS </td><td>READ/WRITE </td></tr>
<tr>
<td>0xFFFF </td><td>4 </td><td>CURRENT BLOCK INDEX </td><td>READ/WRITE </td></tr>
<tr>
<td>0xFFFF </td><td>5 </td><td>BLOCK #1:D0-D3 </td><td>READ/WRITE </td></tr>
<tr>
<td>0xFFFF </td><td>6 </td><td>BLOCK #2:D4-D7 </td><td>READ/WRITE </td></tr>
<tr>
<td>0xFFFF </td><td>.... </td><td>BLOCK #..... </td><td>READ/WRITE </td></tr>
<tr>
<td>0xFFFF </td><td>68 </td><td>BLOCK #64:D252-D255 </td><td>READ/WRITE </td></tr>
</table>
<p><br  />
</p>
<h4><a class="anchor" id="autotoc_md61"></a>
Loader Start Program Flash Register: Address 0xFFFF::0</h4>
<p >The Device shall return the program start address when the Gantry reads this register; </p><dl class="section attention"><dt>Attention</dt><dd>The program start address shall not include the Device Bios(loader) space.<br  />
 The Loader section of the Device program can be programmed only with the Hardware programmer.</dd></dl>
<h4><a class="anchor" id="autotoc_md62"></a>
Loader End Program Flash Register: Address 0xFFFF::1</h4>
<p >The Device shall return the program end address when the Gantry reads this register;<br  />
 </p>
<h4><a class="anchor" id="autotoc_md63"></a>
Loader Checksum Flash Register: Address 0xFFFF::2</h4>
<p >The Gantry writes this register setting the calculated checksum of the writing program code blocks;</p>
<h4><a class="anchor" id="autotoc_md64"></a>
Loader Command Register: Address 0xFFFF::3</h4>
<p >The Gantry writes this register in order to activate a Loader command;<br  />
 </p><a class="anchor" id="LOADER-COMMAND-OD"></a>
<table class="doxtable">
<caption>Loader Command Register</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 </th><th>D1 </th><th>D2 </th><th>D3 </th></tr>
<tr>
<td>0xFFFF </td><td>3 </td><td>COMMAND </td><td>- </td><td>- </td><td>- </td></tr>
</table>
<p><br  />
 </p><a class="anchor" id="COMMAND-OD-CODES"></a>
<table class="doxtable">
<caption>Loader Command Codes</caption>
<tr>
<th>COMMAND </th><th>DESCRIPTION </th></tr>
<tr>
<td>1 </td><td>WRITE BLOCK </td></tr>
<tr>
<td>2 </td><td>VERIFY </td></tr>
</table>
<p><br  />
 </p>
<h4><a class="anchor" id="autotoc_md65"></a>
Loader Block Index Register: Address 0xFFFF::4</h4>
<p >The Gantry writes this register in order to set the current program data block index that<br  />
 is currently ready to be programmed.<br  />
 </p>
<h4><a class="anchor" id="autotoc_md66"></a>
Loader Block Data Register: Address 0xFFFF::5 - 0xFFFF::68</h4>
<p >Each register of this range contains four of the total 256 programa data byte of the current block.<br  />
 The Gantry fills those registers with consecutive program data byte to be written.</p>
<a class="anchor" id="LOADER-FLASH-BLOCK-OD"></a>
<table class="doxtable">
<caption>Loader Flash Block Register</caption>
<tr>
<th>Idx </th><th>SubIdx </th><th>D0 </th><th>D1 </th><th>D2 </th><th>D3 </th></tr>
<tr>
<td>0xFFFF </td><td>5 </td><td>B[0] </td><td>B[1] </td><td>B[2] </td><td>B[3] </td></tr>
<tr>
<td>0xFFFF </td><td>6 </td><td>B[4] </td><td>B[5] </td><td>B[6] </td><td>B[7] </td></tr>
<tr>
<td>0xFFFF </td><td>... </td><td>B[...] </td><td>B[...] </td><td>B[...] </td><td>B[...] </td></tr>
<tr>
<td>0xFFFF </td><td>68 </td><td>B[252] </td><td>B[253] </td><td>B[254] </td><td>B[255] </td></tr>
</table>
<p><br  />
 </p>
<h3><a class="anchor" id="autotoc_md67"></a>
Loader Procedure</h3>
<dl class="section attention"><dt>Attention</dt><dd>In this section, whenever the description refers to a Command execution,<br  />
 it is intended that this command shall be implemetated exactly as already described in the Command protocol implementation section.<br  />
 Here it will not be replicated all the possible scenarios description related to command acceptance, completion or errors,<br  />
 given that they are been already described previously.</dd></dl>
<ol type="1">
<li>Gantry activates the Device's loader, sending the <a class="el" href="_p_g__t_d__c_a_n__o_p_e_n.html#LOADER-NMT">LOADER-NMT</a> packet;<ul>
<li>Gantry shall check the Device Status register (0x0000::0) in order to check the Loader activation;</li>
</ul>
</li>
<li>Gantry shall read the START FLASH address (0xFFFF::1) and the END FLASH address (0xFFFF::2)<br  />
 in order to upload only the correct device's program memory segments;</li>
<li>Gantry shall write the CHECKSUM register address (0xFFFF::2) with the calculated checksum of the device's program memory segments (Start to End address only);</li>
<li>For every 256 data block of the program data, the Gantry shall repeat the following steps:<ul>
<li>writes the Block Index Register address (0xFFFF::4) with the current block index;</li>
<li>writes the Data Block Registers (0xFFFF::5 0xFFFF::68) with the program data of the related block;<ul>
<li>if the size of the last program block should be lower then 256 bytes, the remaining registers of the block shall be filled with 0xFF;</li>
</ul>
</li>
<li>Gantry shall request the execution of the Loader Command Register (0xFFFF::3) with the COMMAND = WRITE BLOCK;<ul>
<li>In case of error the Gantry shall termines the Loading procedure;</li>
</ul>
</li>
<li>Gantry shall read the Loader Command Register (0xFFFF::3) in order to check the program completion;<ul>
<li>In case of error the Gantry shall termines the Loading procedure;</li>
</ul>
</li>
</ul>
</li>
<li>Gantry shall request the execution of the Loader Command Register (0xFFFF::3) with the COMMAND = VERIFY;<ul>
<li>In case of error the Gantry shall termines the Loading procedure;</li>
<li>Device shall compute the local checksum of the written program segments comparing the result with the crc of the register 0xFFFF::2.</li>
</ul>
</li>
<li>Gantry shall read the Loader Command Register (0xFFFF::3) in order to check the verfy completion;<ul>
<li>In case of error the Gantry shall termines the Loading procedure;</li>
</ul>
</li>
<li>Gantry termins the loading session sending the <a class="el" href="_p_g__t_d__c_a_n__o_p_e_n.html#IDLE-NMT">IDLE-NMT</a> packet;</li>
</ol>
<h1><a class="anchor" id="autotoc_md68"></a>
Implementation Class</h1>
<p >The Class that implements the current protocol is <a class="el" href="classcan_open_interface.html">canOpenInterface</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
